function setupYoutubePlayer(e){var t=document.createElement("script");t.src="http://www.youtube.com/iframe_api",$(t).prependTo("body"),youtube.videoId=e,$("#graph").css("display","inline-block"),$("#result").css("display","inline-block")}function onYouTubeIframeAPIReady(){youtube.player=new YT.Player("player",{height:"285",width:"330",videoId:youtube.videoId,playerVars:{wmode:"opaque"},events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange}}),$("#player").addClass("youtube-player")}function onPlayerReady(e){e.target.setPlaybackQuality("small")}function onPlayerStateChange(e){e.data==YT.PlayerState.PLAYING?(youtube.isPlaying=!0,clearTimeout(waveform.timelineOffsetHandler),youtube.currentTimeRecord=youtube.player.getCurrentTime(),waveform.isClickNewTimelineOffset?youtube.player.seekTo(waveform.timelineOffset*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor,!0):waveform.timelineOffset=Math.floor(youtube.player.getCurrentTime()/waveform.timeElapsedPerPixel*waveform.horizontalScaleFactor/100),(waveform.timelineOffset<$("#graph").scrollLeft()||waveform.timelineOffset>$("#graph").scrollLeft()+waveform.globalGraph.width())&&$("#graph").scrollLeft(waveform.timelineOffset-waveform.timelineOffset%$("#graph").width()),waveform.timelineOffsetHandler=setInterval(function(){var e=youtube.player.getCurrentTime();if(waveform.isClickNewTimelineOffset?(clearTimeout(waveform.timelineOffsetHandler),youtube.player.seekTo(waveform.timelineOffset*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor,!0),waveform.isClickNewTimelineOffset=!1):e==youtube.currentTimeRecord?waveform.timelineOffset+=waveform.horizontalScaleFactor/100:(youtube.currentTimeRecord=e,waveform.timelineOffset=Math.floor(e/waveform.timeElapsedPerPixel*waveform.horizontalScaleFactor/100)),control.isLoop&&isSelecting()){var t=waveform.selectionEndOffset>waveform.selectionStartOffset?waveform.selectionEndOffset:waveform.selectionStartOffset;if(waveform.timelineOffset>t){var a=waveform.selectionEndOffset<waveform.selectionStartOffset?waveform.selectionEndOffset:waveform.selectionStartOffset;youtube.player.seekTo(a*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor,!0),waveform.timelineOffset=a,graphScroll(a,t-a)}}else if(waveform.isSetAnchor&&$("#select-area-start").is(":visible")){waveform.timelineOffset<waveform.selectionStartOffset?($("#select-area-end").css("left",waveform.timelineOffset-3),$("#select-area").css("left",waveform.timelineOffset).width(waveform.selectionStartOffset-waveform.timelineOffset)):($("#select-area-end").css("left",waveform.timelineOffset),$("#select-area").css("left",waveform.selectionStartOffset).width(waveform.timelineOffset-waveform.selectionStartOffset)),waveform.selectionEndOffset=waveform.timelineOffset;var o=$("#selected-area-"+waveform.pseudoNodeIndex);o.length&&waveform.selectionEndOffset>=o.position().left+$("#graph").scrollLeft()&&(waveform.timelineOffset=o.position().left+$("#graph").scrollLeft(),youtube.player.seekTo(waveform.timelineOffset*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor,!0),pauseVideo(),$("#select-area-end").css("left",waveform.timelineOffset),$("#select-area").css("left",waveform.selectionStartOffset).width(waveform.timelineOffset-waveform.selectionStartOffset),waveform.selectionEndOffset=waveform.timelineOffset)}(Math.floor(waveform.timelineOffset)>=$("#graph").scrollLeft()+$("#graph").width()||Math.floor(waveform.timelineOffset)<$("#graph").scrollLeft())&&(waveform.timelineOffset=Math.floor(e/waveform.timeElapsedPerPixel)*waveform.horizontalScaleFactor/100,$("#graph").scrollLeft(waveform.timelineOffset)),waveform.timelineNode.css("left",waveform.timelineOffset)},1e3*waveform.timeElapsedPerPixel)):e.data==YT.PlayerState.PAUSED&&(clearTimeout(waveform.timelineOffsetHandler),control.isLoop=!1,$("#loop-mask").hide(),$("#loop").tooltip("option","content","循環播放"),youtube.isPlaying=!1)}function pauseVideo(){youtube.player.pauseVideo()}function stopVideo(){youtube.player.stopVideo()}function drawNewWaveform(e,t){for(var a=$("#svg").height(),o=a/65536*(waveform.verticalScaleFactor/100),n=e;t>n&&n<waveform.data.min.length;n++){var r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttributeNS(null,"x",n*waveform.horizontalScaleFactor/100),r.setAttributeNS(null,"y",a/2-waveform.data.max[n]*o),r.setAttributeNS(null,"width",1*waveform.horizontalScaleFactor/100),r.setAttributeNS(null,"height",(Math.abs(waveform.data.min[n])+waveform.data.max[n])*o),waveform.globalSvg.appendChild(r)}waveform.endNodeIndex=t>waveform.data.min.length?waveform.data.min.length:t}function reorganizeWaveform(){waveform.endNodeIndex<Math.floor(100*($("#graph").scrollLeft()+$("#graph").width())/waveform.horizontalScaleFactor)&&drawNewWaveform(waveform.globalSvg.childNodes.length,Math.floor(100*($("#graph").scrollLeft()+$("#graph").width())/waveform.horizontalScaleFactor))}function pixelOffsetToNodeIndex(e){return Math.floor(e/waveform.horizontalScaleFactor*100)}function screenXsetToNodeIndex(e){return pixelOffsetToNodeIndex(e+$("#graph").scrollLeft())}function placeTimeStamp(e,t,a,o,n){waveform.timeElapsedPerPixel=1/t*(a/n);for(var r,i=1/waveform.timeElapsedPerPixel,s=0,l=1*e/100,c=0;o+1>=c;c+=l)r=""+c%60,1==r.length&&(r="0"+r),$("<span class='timestamp'></span>").text(""+Math.floor(c/60)+":"+r).css({left:s}).appendTo($("#timestamp")),s+=i*l}function secondToMinute(e){var t=""+e%60;return 1==t.length&&(t="0"+t),""+Math.floor(e/60)+":"+t}function verticalScale(e,t,a){for(var o=$("#svg").height(),n=o/65536,r=e/100,i=t;a>i&&waveform.globalSvg.childNodes.length;i++)null!=waveform.globalSvg.childNodes[i]&&(waveform.globalSvg.childNodes[i].setAttributeNS(null,"y",o/2-r*waveform.data.max[i]*n),waveform.globalSvg.childNodes[i].setAttributeNS(null,"height",(Math.abs(waveform.data.min[i])+waveform.data.max[i])*n*r))}function horizontalScale(e,t,a){for(var o=e/100,n=t;a>n&&waveform.globalSvg.childNodes.length;n++)null!=waveform.globalSvg.childNodes[n]&&(waveform.globalSvg.childNodes[n].setAttributeNS(null,"x",n*o),waveform.globalSvg.childNodes[n].setAttributeNS(null,"width",o))}function getMouseOnGraphOffset(e){return $("#graph").scrollLeft()-$("#container").offset().left+e.pageX}function determineSelectArea(e){waveform.selectionEndOffset=e,waveform.selectionEndOffset<waveform.selectionStartOffset?$("#select-area").css("left",waveform.selectionEndOffset).width(waveform.selectionStartOffset-waveform.selectionEndOffset):$("#select-area").css("left",waveform.selectionStartOffset).width(waveform.selectionEndOffset-waveform.selectionStartOffset)}function isInSvg(e){var t=e.pageY+$(document).scrollTop()-$("#graph").offset().top;return t>=0&&t<=$("#svg").height()}function getPseudoNodeIndex(e){for(var t=1;t<=edit.numberOfRow&&e>=$("#graph").scrollLeft()+$("#selected-area-"+t).position().left;t++);return t}function mouseoverSelectedArea(e){if(waveform.pseudoNodeIndex>1&&waveform.pseudoNodeIndex<=edit.numberOfRow){if(e>$("#selected-area-"+waveform.pseudoNodeIndex).position().left+$("#graph").scrollLeft()||e<$("#selected-area-"+(waveform.pseudoNodeIndex-1)).position().left+$("#graph").scrollLeft()+$("#selected-area-"+(waveform.pseudoNodeIndex-1)).width())return!0}else if(1!=waveform.pseudoNodeIndex||waveform.pseudoNodeIndex>edit.numberOfRow){if(waveform.pseudoNodeIndex==edit.numberOfRow+1&&edit.numberOfRow>0&&e<$("#selected-area-"+(waveform.pseudoNodeIndex-1)).position().left+$("#graph").scrollLeft()+$("#selected-area-"+(waveform.pseudoNodeIndex-1)).width())return!0}else if(e>$("#selected-area-"+waveform.pseudoNodeIndex).position().left+$("#graph").scrollLeft())return!0;return!1}function checkDictionarySource(e,t,a,o){0==e.data("source").length?$.ajax({type:"GET",url:"lookup/"+encodeURI(t),async:!1,dataType:"json",success:function(n){e.data("source",n.translations),void 0!==e.data("source")[0]&&""==e.val()&&e.val(e.data("source")[0]),a&&triggerAutocomplete(e),void 0!==o&&annotateReading(o,t,n.reading)}}):a&&triggerAutocomplete(e)}function triggerAutocomplete(e){e.focus(),e.autocomplete("search","")}function setAnchor(){$("#anchor-annotation").is(":visible")?(waveform.isSetAnchor=!1,$("#anchor-annotation").hide(),$("#anchor-mask").hide(),$(this).tooltip("option","content","設下錨點")):$("#select-area-start").is(":visible")&&(waveform.isSetAnchor=!0,moveAnchorAnnotation(),$("#anchor-mask").show(),$(this).tooltip("option","content","拔起錨點"))}function moveAnchorAnnotation(){$("#anchor-annotation").show().css("left",$("#graph").scrollLeft()+$("#select-area-start").position().left-9+"px")}function clearScrollHandler(){clearTimeout(waveform.leftScrollHandler),waveform.leftScrollHandler=null,clearTimeout(waveform.rightScrollHandler),waveform.rightScrollHandler=null}function resizeSelectAreaFromStartOffset(e){e<waveform.selectionEndOffset?($("#select-area-start").css("left",e-3),$("#select-area").css("left",e).width(waveform.selectionEndOffset-e),waveform.selectionStartOffset=e,waveform.isSetAnchor&&moveAnchorAnnotation()):waveform.isSetAnchor?($("#select-area-start").css("left",e-3),$("#select-area").css("left",waveform.selectionEndOffset).width(e-waveform.selectionEndOffset),waveform.selectionStartOffset=e,moveAnchorAnnotation()):($("#select-area-start").css("left",waveform.selectionEndOffset-3),$("#select-area").css("left",waveform.selectionEndOffset).width(e-waveform.selectionEndOffset),$("#select-area-end").css("left",e),waveform.selectionStartOffset=waveform.selectionEndOffset,waveform.selectionEndOffset=e,waveform.isSelectAreaStartMouseDown=!1,waveform.isSelectAreaEndMouseDown=!0)}function resizeSelectAreaFromEndOffset(e){e>waveform.selectionStartOffset?($("#select-area").css("left",waveform.selectionStartOffset).width(e-waveform.selectionStartOffset),$("#select-area-end").css("left",e),waveform.selectionEndOffset=e):waveform.isSetAnchor?($("#select-area").css("left",e).width(waveform.selectionStartOffset-e),$("#select-area-end").css("left",e),waveform.selectionEndOffset=e):($("#select-area-start").css("left",e-3),$("#select-area").css("left",e).width(waveform.selectionStartOffset-e),$("#select-area-end").css("left",waveform.selectionStartOffset),waveform.selectionEndOffset=waveform.selectionStartOffset,waveform.selectionStartOffset=e,waveform.isSelectAreaEndMouseDown=!1,waveform.isSelectAreaStartMouseDown=!0)}function adjustSelectedAreaFromStartLine(e){var t=$("#selected-area-"+waveform.focusSelectAreaIndex);e<$("#graph").scrollLeft()+t.position().left+t.width()?($("#selected-area-start-"+waveform.focusSelectAreaIndex).css("left",e-3),t.width(t.width()-e+($("#graph").scrollLeft()+t.position().left)).css("left",e),getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(2)").text(toSrtTime(e*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor)),edit.currentEditIndex==waveform.focusSelectAreaIndex&&(waveform.selectionStartOffset=e)):($("#selected-area-start-"+waveform.focusSelectAreaIndex).css("left",$("#graph").scrollLeft()+$("#selected-area-end-"+waveform.focusSelectAreaIndex).position().left-3),t.width(e-($("#graph").scrollLeft()+$("#selected-area-end-"+waveform.focusSelectAreaIndex).position().left)).css("left",$("#graph").scrollLeft()+$("#selected-area-end-"+waveform.focusSelectAreaIndex).position().left),$("#selected-area-end-"+waveform.focusSelectAreaIndex).css("left",e),getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(2)").text(getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(3)").text()),getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(3)").text(toSrtTime(e*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor)),edit.currentEditIndex==waveform.focusSelectAreaIndex&&(waveform.selectionStartOffset=waveform.selectionEndOffset,waveform.selectionEndOffset=e),waveform.isAdjustStartSelectLine=!1,waveform.isAdjustEndSelectLine=!0)}function adjustSelectedAreaFromEndLine(e){var t=$("#selected-area-"+waveform.focusSelectAreaIndex);e>$("#graph").scrollLeft()+t.position().left?($("#selected-area-end-"+waveform.focusSelectAreaIndex).css("left",e),t.width(e-($("#graph").scrollLeft()+t.position().left)),getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(3)").text(toSrtTime(e*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor)),edit.currentEditIndex==waveform.focusSelectAreaIndex&&(waveform.selectionEndOffset=e)):($("#selected-area-end-"+waveform.focusSelectAreaIndex).css("left",$("#graph").scrollLeft()+$("#selected-area-start-"+waveform.focusSelectAreaIndex).position().left),t.width($("#graph").scrollLeft()+$("#selected-area-start-"+waveform.focusSelectAreaIndex).position().left-e).css("left",e),$("#selected-area-start-"+waveform.focusSelectAreaIndex).css("left",e-3),getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(3)").text(getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(2)").text()),getSubtitleRow(waveform.focusSelectAreaIndex).children(":nth-child(2)").text(toSrtTime(e*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor)),edit.currentEditIndex==waveform.focusSelectAreaIndex&&(waveform.selectionEndOffset=waveform.selectionStartOffset,waveform.selectionStartOffset=e),waveform.isAdjustEndSelectLine=!1,waveform.isAdjustStartSelectLine=!0)}function determineScroll(e){e-$("#graph").scrollLeft()<50?constScroll("left",4):e-$("#graph").scrollLeft()>550&&constScroll("right",4)}function constScroll(e,t){"left"==e&&null==waveform.leftScrollHandler?(clearScrollHandler(),waveform.leftScrollHandler=setInterval(function(){$("#graph").scrollLeft($("#graph").scrollLeft()-t);var e=$(waveform.isAdjustStartSelectLine||waveform.isAdjustEndSelectLine?"#selected-area-end-"+(waveform.focusSelectAreaIndex-1):"#selected-area-end-"+(waveform.pseudoNodeIndex-1));e.length&&e.position().left>20&&clearScrollHandler()},18)):"right"==e&&null==waveform.rightScrollHandler&&(clearScrollHandler(),waveform.rightScrollHandler=setInterval(function(){$("#graph").scrollLeft($("#graph").scrollLeft()+t);var e=$(waveform.isAdjustStartSelectLine||waveform.isAdjustEndSelectLine?"#selected-area-start-"+(waveform.focusSelectAreaIndex+1):"#selected-area-start-"+waveform.pseudoNodeIndex);e.length&&e.position().left<590&&clearScrollHandler()},18))}function getStringWidth(e,t){return Math.floor($("#stringWidth").html(e).width()+t)}function adjustVocabularyHandler(e){isChangeText(e)&&adjustVocabularyWidth($(this).index()+1)}function adjustVocabularyWidth(e){var t=$("#footer-japanese").children(":nth-child("+e+")"),a=$("#footer-chinese").children(":nth-child("+e+")"),o=getStringWidth(t.val(),10),n=a.width(),r=o>n?o:n;r=Math.ceil(r),t.innerWidth(r),a.innerWidth(r),a.find("input").width(r-a.find("a").width()-4)}function findJapaneseVocab(e){return $("#footer-japanese").children(":nth-child("+(e+1)+")")}function composeString(e){if(13==e.keyCode){var t=$(this).getCursorPosition();if(0!=t&&t!=$(this).val().length){var a=getJapaneseVocab().val($(this).val().substring(t)).insertAfter($(this)).focus().caretTo(0),o=$("#footer-chinese").children(":nth-child("+($(this).index()+1)+")");$combobox=getCombobox(),$combobox.combobox({source:[]}),$combobox.insertAfter(o),adjustVocabularyWidth($(this).index()+1+1),validateFooterInput(a),$(this).val($(this).val().substring(0,t)),$mycombobox=getCombobox(),$mycombobox.combobox({source:[]}),$mycombobox.insertAfter(o),o.remove(),adjustVocabularyWidth($(this).index()+1),validateFooterInput($(this));var n=$(this).index()-2;$("#footer-reading input").each(function(){var e=$(this).attr("data-position").split("-"),t=parseInt(e[0]),a=parseInt(e[1]),o=parseInt(e[2]);t==n?$(this).parent().remove():t>n&&(placeReadingSpan(t+1,a,o,$(this).val()),$(this).parent().remove())}),checkDictionarySource($combobox.find("input"),a.val(),!1,n+1),checkDictionarySource($mycombobox.find("input"),$(this).val(),!1,n),hasChanged()}}else if(8==e.keyCode){var t=$(this).getCursorPosition();if(0==t&&$(this).index()>2){var r=$(this).prev().val()+$(this).val(),i=$(this).val(r).focus(),o=$("#footer-chinese").children(":nth-child("+($(this).index()+1)+")");$combobox=getCombobox(),$combobox.combobox({source:[]}),$combobox.insertAfter(o),o.remove();var s=$(this).index(),n=$(this).index()-2;return $("#footer-japanese").children(":nth-child("+s+")").remove(),$("#footer-chinese").children(":nth-child("+s+")").remove(),adjustVocabularyWidth(s),validateFooterInput(i),$("#footer-reading input").each(function(){var e=$(this).attr("data-position").split("-"),t=parseInt(e[0]),a=parseInt(e[1]),o=parseInt(e[2]);t==n-1?$(this).parent().remove():t==n?$(this).parent().remove():t>n&&(placeReadingSpan(t-1,a,o,$(this).val()),$(this).parent().remove())}),checkDictionarySource($combobox.find("input"),i.val(),!1,n-1),hasChanged(),!1}}}function editPanelReset(){edit.isShowVocab=!1,$("#footer-reading").children(":gt(0)").remove(),$("#footer-japanese-sentence").val(""),$("#footer-japanese").children(":gt(1)").remove(),$("#footer-chinese").children(":gt(1)").remove(),$("#footer-chinese>input").val(""),$("#footer-grammar").children(":gt(0)").remove(),$("#footer-body").scrollLeft(0)}function isChangeText(e){var t=e.keyCode,a=t>47&&58>t||32==t||13==t||t>64&&91>t||t>95&&112>t||t>185&&193>t||t>218&&223>t||8==t||46==t;return a}function checkFormat(){var e="";return $("#footer-jap-vocabulary").children("input").each(function(){e+=$(this).val()}),e!=$("#footer-sentence").children(":nth-child(2)").val()?!1:!0}function enterable(e){13==e.keyCode&&"checkbox"==$(this).attr("type")&&($(this).prop("checked")?$(this).prop("checked",!1):$(this).prop("checked",!0))}function clickToFocus(){$(this).focus()}function grammarReorgainize(){$("#grammar-description").hide()}function hasChanged(){edit.changed[edit.currentEditIndex]=!0}function clearChanged(){edit.changed[edit.currentEditIndex]=!1}function getGrammar(e){var t=$('<label title="'+e.explanation+'" class="grammar-element"><input type="checkbox" name="grammar[]" value="'+e.id+'">'+e.baseForm+"</label>").keydown(traversable).tooltip(tooltipInit);return t.children("input").click(clickToFocus).keydown(enterable).focusout(grammarReorgainize).bind("change",hasChanged),t}function determineGrammar(){if(isEditing()&&edit.isJapaneseSentenceChanged){var e=$("#footer-japanese-sentence").val().trim();""!=e?$.ajax({type:"GET",url:"/grammar",data:{sentence:encodeURI(e)},dataType:"json",success:function(e){var t=$("#footer-grammar"),a=[];t.find("input").each(function(){$(this).prop("checked")&&(a[$(this).val()]=!0)}),t.children(":gt(0)").remove(),edit.isJapaneseSentenceChanged=!1;for(var o=0;o<e.grammar.length;o++){var n=getGrammar(e.grammar[o]);a[n.children("input").val()]&&n.children("input").prop("checked",!0),t.append(n)}$("#footer-reading > span").remove(),$footerJapanese=$("#footer-japanese"),$footerChinese=$("#footer-chinese"),$footerJapanese.children(":gt(1)").remove(),$footerChinese.children(":gt(1)").remove();for(var o=0;o<e.vocabulary.length;o++){var r=e.vocabulary[o].surfaceForm;$footerJapanese.append(getJapaneseVocab().val(r));var i=e.vocabulary[o].translations;$combobox=getCombobox(),$combobox.combobox({source:i}),$footerChinese.append($combobox),adjustVocabularyWidth(o+3),annotateReading(o,r,e.vocabulary[o].reading)}}}):"undefined"!=typeof grammars&&0!=grammars.grammar.length&&""!=e||subtitleRow.data("grammar",{grammar:[]})}}function annotateReading(e,t,a){if("?"!=a&&""!=a&&"「"!=a&&"」"!=a){for(var o=wanakana._katakanaToHiragana(a),n=0,r=0;r<t.length;r++)if(n<o.length&&o[n]==t[r]&&n++,wanakana._isCharNotKana(t[r])&&" "!=t[r]&&"　"!=t[r]){for(var i=r+1;i<t.length&&wanakana._isCharNotKana(t[i]);)i++;for(var s=i;s<t.length&&wanakana._isCharHiragana(t[s]);)s++;for(var l=t.substring(i,s),c=n+1;c<o.length&&(""==l||0!=o.substring(c).indexOf(l));)c++;placeReadingSpan(e,r,i,o.substring(n,c)),r=i-1,n=c}}else for(var r=0;r<t.length;r++)if(wanakana._isCharNotKana(t[r])&&" "!=t[r]&&"　"!=t[r]&&"「"!=t[r]&&"」"!=t[r]&&!/^[A-Za-z0-9]+$/.test(t[r])){for(var i=r+1;i<t.length&&wanakana._isCharNotKana(t[i]);)i++;for(var f="",d=0;i-r>d;d++)f+=" ";placeReadingSpan(e,r,i,f),r=i}}function placeReadingSpan(e,t,a,o){var n=$("#footer-japanese").children(":nth-child("+(3+e)+")"),r=(n.width()-16*n.val().length)/2+n.position().left+1,i=a-t,s=o.length,l=getReadingSpan().css("left",r+16*t-(6*s+1-8*i)+"px");l.find("input").val(o).attr("data-position",e+"-"+t+"-"+a).bind("input",hasChanged).keydown(traversable).width(12*s);for(var c=$("#footer-reading>span"),f=0;f<=c.length;f++)if(f==c.length)l.appendTo("#footer-reading");else{var d=$(c[f]).find("input").attr("data-position");if(e<parseInt(d[0])){$(c[f]).before(l);break}if(e==parseInt(d[0])&&t<parseInt(d[1])){$(c[f]).before(l);break}}return l}function getReadingSpan(){return $('<span style="position:absolute;"><input style="font-size:10px;" class="subtitle-sentence"/></span>')}function getCombobox(){return $("<span class='custom-combobox'></span>")}function scrollToRow(e){$("#edit").scrollTop(21*e.index())}function changeRowFocus(e,t){t=void 0!==t?t:!0,recordRow(edit.currentEditIndex),$("#selected-area-"+edit.currentEditIndex).removeClass("focus"),getSubtitleRow(edit.currentEditIndex).removeClass("focus-row"),edit.currentEditIndex=parseInt(e.children("div.index").text()),moveToSelectedArea($("#selected-area-"+edit.currentEditIndex),t),$("#selected-area-"+edit.currentEditIndex).addClass("focus"),e.addClass("focus-row"),scrollToRow(e),editPanelReset();for(var a=0;a<e.data("japanese").length;a++)if(a>0){edit.isShowVocab=!0;var o=getJapaneseVocab().val(e.data("japanese")[a]);$("#footer-japanese").append(o),validateFooterInput(o)}else validateFooterInput($("#footer-japanese-sentence").val(e.data("japanese")[a]));for(var a=0;a<e.data("chinese").length;a++)if(a>0){var n=getCombobox();n.combobox({source:[]}),n.find("input").val(e.data("chinese")[a]),$("#footer-chinese").append(n)}else validateFooterInput($("#footer-chinese-sentence").val(e.data("chinese")[a]));for(var a=0;a<e.data("grammar").grammar.length;a++){var r=getGrammar(e.data("grammar").grammar[a]);r.appendTo($("#footer-grammar")),e.data("checked")[a]&&$(r).find("input[type='checkbox']").prop("checked",!0)}for(var a=0;a<e.data("japanese").length;a++)adjustVocabularyWidth(a+3);for(var a=0;a<e.data("reading").length;a++){var i=e.data("position")[a].split("-"),s=i[0],l=i[1],c=i[2];placeReadingSpan(parseInt(s),parseInt(l),parseInt(c),e.data("reading")[a])}$("#footer-japanese-sentence").focus(),waveform.isSetAnchor=!1,$("#anchor-annotation").hide()}function graphScroll(e,t){(e<$("#graph").scrollLeft()||e+t>=$("#graph").scrollLeft()+$("#graph").width())&&$("#graph").scrollLeft(t>$("#graph").width()?$("#graph").scrollLeft()+e:$("#graph").scrollLeft()+e-($("#graph").width()-t)/2)}function moveToSelectedArea(e,t){t=void 0!==t?t:!0,hideSelectArea(),t&&graphScroll(e.position().left,e.width()),waveform.selectionStartOffset=$("#graph").scrollLeft()+e.position().left,waveform.selectionEndOffset=$("#graph").scrollLeft()+e.position().left+e.width(),$("#timeline-offset").css("left",waveform.selectionStartOffset),waveform.timelineOffset=waveform.selectionStartOffset,waveform.isClickNewTimelineOffset=!0}function getSelectedArea(e,t,a){return $("<div id='selected-area-"+e+"' class='selected-area'></div>").css({width:t,height:$("#select-area").height(),left:a}).mousedown(function(){var e=getSubtitleRow($(this).attr("id").split("-")[2]);changeRowFocus(e),waveform.isFocusSelectedArea=!0})}function getSelectedAreaStart(e,t){return $("<div id='selected-area-start-"+e+"' class='select-line'></div>").css({height:$("#svg").height(),left:$("#graph").scrollLeft()+t.position().left-3,display:"inline-block"}).mousedown(function(){waveform.isAdjustStartSelectLine=!0,waveform.focusSelectAreaIndex=parseInt($(this).attr("id").split("-")[3]);var e=getSubtitleRow(waveform.focusSelectAreaIndex);changeRowFocus(e,!1),waveform.isFocusSelectedArea=!0})}function getSelectedAreaEnd(e,t){return $("<div id='selected-area-end-"+e+"' class='select-line'></div>").css({height:$("#svg").height(),left:$("#graph").scrollLeft()+t.position().left+t.width(),display:"inline-block"}).mousedown(function(){waveform.isAdjustEndSelectLine=!0,waveform.focusSelectAreaIndex=parseInt($(this).attr("id").split("-")[3]);var e=getSubtitleRow(waveform.focusSelectAreaIndex);changeRowFocus(e,!1),waveform.isFocusSelectedArea=!0})}function secondToPixel(e){return e*waveform.horizontalScaleFactor/100/waveform.timeElapsedPerPixel}function pixelToSecond(e){return e*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor}function restoreSubtitles(e){e.sort(function(e,t){return e.index<t.index?1:e.index>t.index?-1:0}),edit.numberOfRow=e.length;for(var t=0;t<e.length;t++){var a=toSecond(e[t].startTime),o=toSecond(e[t].endTime);edit.currentEditIndex=e[t].index;var n=getSelectedArea(e[t].index,secondToPixel(o-a),secondToPixel(a));n.prependTo("#graph"),getSelectedAreaStart(e[t].index,n).insertBefore(n),getSelectedAreaEnd(e[t].index,n).insertAfter(n);var r=$("#clone-base-row").clone(!0,!0).removeAttr("id").show().prependTo($("#subtitle-body"));fillInSubtitleRow($("#selected-area-"+edit.currentEditIndex),r,!1,edit.currentEditIndex,e[t].startTime,e[t].endTime,e[t].japaneseSentence),initSubtitleRow(r,e[t]),clearChanged()}}function initSubtitleRow(e,t){e.data("japanese",[]),e.data("japanese")[0]=t.japaneseSentence;for(var a=0;a<t.japaneseVocab.length;a++)e.data("japanese")[a+1]=t.japaneseVocab[a];e.data("chinese",[]),e.data("chinese")[0]=t.chineseSentence;for(var a=0;a<t.chineseVocab.length;a++)e.data("chinese")[a+1]=t.chineseVocab[a];e.data("grammar",{grammar:t.matched}),e.data("checked",[]);for(var a=0;a<t.matched.length;a++)-1!=t.checked.indexOf(t.matched[a].id)&&(e.data("checked")[a]=!0);if(e.data("reading",[]),t.reading)for(var a=0;a<t.reading.length;a++)e.data("reading")[a]=t.reading[a];if(e.data("position",[]),t.position)for(var a=0;a<t.position.length;a++)e.data("position")[a]=t.position[a]}function fillInSubtitleRow(e,t,a,o,n,r,i){a&&(e.addClass("focus"),t.addClass("focus-row"),$("#footer-japanese-sentence").focus()),t.find("div.index").html(o),t.children(":nth-child(2)").html(n),t.children(":nth-child(3)").html(r),t.children(":nth-child(4)").html(i)}function recordSelectArea(){for(var e=($("#graph").scrollLeft()+$("#select-area").position().left)*waveform.timeElapsedPerPixel*100/waveform.horizontalScaleFactor,t=edit.numberOfRow;t>=1&&e<=toSecond(getSubtitleRow(t).children(":nth-child(2)").text());t--);for(var a=edit.numberOfRow;a>t;a--)$("#selected-area-"+a).attr("id","selected-area-"+(a+1)),$("#selected-area-start-"+a).attr("id","selected-area-start-"+(a+1)),$("#selected-area-end-"+a).attr("id","selected-area-end-"+(a+1)),getSubtitleRow(a).children(":nth-child(1)").html(a+1);var o=getSelectedArea(t+1,$("#select-area").width(),$("#graph").scrollLeft()+$("#select-area").position().left);return 0==t?o.prependTo("#graph"):o.insertAfter($("#selected-area-end-"+t)),getSelectedAreaStart(t+1,o).insertBefore(o),getSelectedAreaEnd(t+1,o).insertAfter(o),t}function isSelecting(){return waveform.selectionStartOffset!=waveform.selectionEndOffset}function isChanged(e){return edit.changed[e]}function update(e,t){for(var a=getSubtitleRow(e),o=[],n=[],r=0;r<a.data("grammar").grammar.length;r++){var i=a.data("grammar").grammar[r].id;o.push(i),a.data("checked")[r]&&n.push(i)}for(var s=a.data("japanese").slice(1),l=a.data("reading"),c=a.data("position"),r=0;r<l.length;r++){var f=c[r].split("-"),d=parseInt(f[0]),u=parseInt(f[1]),h=parseInt(f[2]);s[d]=s[d].substring(0,u)+l[r]+s[d].substring(h)}$.ajax({type:"POST",url:"update/"+youtube.videoId+"/"+e,data:{data:JSON.stringify({startTime:getStartTime(a),endTime:getEndTime(a),japaneseSentence:a.data("japanese")[0],chineseSentence:a.data("chinese")[0],japaneseVocab:a.data("japanese").slice(1),chineseVocab:a.data("chinese").slice(1),matched:o,checked:n,reading:l,position:c,readings:s})},async:t,dataType:"json",success:function(){}})}function recordRow(e,t){if(isEditing()&&isChanged(e)){void 0===t&&(t=!0);var a=getSubtitleRow(e);a.data("japanese",[]).data("chinese",[]).data("checked",[]).data("grammar",{grammar:[]}).data("reading",[]).data("position",[]),$("#footer-japanese").children("input").each(function(e){a.data("japanese")[e]=$(this).val()}),$("#footer-chinese").find("input").each(function(e){a.data("chinese")[e]=$(this).val()}),$("#footer-reading").find("input").each(function(e){a.data("reading")[e]=$(this).val(),a.data("position")[e]=$(this).attr("data-position")});var o=[],n=[];$("#footer-grammar").find("input[type='checkbox']").each(function(e){o.push($(this).attr("value")),a.data("grammar").grammar[e]={baseForm:$(this).parent().text(),explanation:$(this).parent().attr("title"),id:o[e]},$(this).prop("checked")&&(n.push($(this).attr("value")),a.data("checked")[e]=!0)}),clearChanged(),update(e,t)}}function getIndex(e){return e.children(":nth-child(1)").text()}function getStartTime(e){return e.children(":nth-child(2)").text()}function getEndTime(e){return e.children(":nth-child(3)").text()}function hideSelectArea(){$("#select-area").width(0),$("#select-area-start").hide(),$("#select-area-end").hide()}function japaneseSentenceBind(e){edit.isJapaneseSentenceChanged=!1,$("#footer-japanese").children(":nth-child(2)").unbind("keyup").keyup(function(t){if(isChangeText(t)){var a=$(this).val();$(e).children(":nth-child(4)").text(a)}}).focus()}function chineseSentenceBind(e){$("#footer-sentence").children(":nth-child(3)").unbind("keyup").keyup(function(t){isChangeText(t)&&$(e).children(":nth-child(5)").html($(this).val())})}function isRepeatAddSelectedArea(){return edit.currentEditIndex<1||waveform.selectionStartOffset!=$("#graph").scrollLeft()+$("#selected-area-"+edit.currentEditIndex).position().left?!1:!0}function getJapaneseVocab(){return $("<input class='subtitle-vocabulary' title='請在此輸入一句日文歌詞' maxlength='"+edit.lengthLimitOfSentence+"'>").keydown(composeString).keydown(traversable).bind("input",hasChanged).bind("input",function(){validateFooterInput($(this))})}function getChineseVocab(){return $("<input class='subtitle-vocabulary' title='請在此輸入上方日文單字對應的中文翻譯'>").keydown(traversable).keyup(adjustVocabularyHandler).bind("input",hasChanged)}function validateFooterInput(e){var t=0,a="";return"subtitle-vocabulary"==e.attr("class")&&-1==e.parent().children("input.subtitle-sentence").val().indexOf(e.val())?(a="單詞不在原本的句子中",t=1):e.val().length>edit.lengthLimitOfSentence?(a="長度超過"+edit.lengthLimitOfSentence+"字",t=1):e.val().length==edit.lengthLimitOfSentence&&(a="長度達到上限"+edit.lengthLimitOfSentence+"字",t=2),0==t?(e.css("background","transparent"),"footer-japanese-sentence"==e.attr("id")||"footer-chinese-sentence"==e.attr("id"),!0):1==t?(e.css("background","red"),!1):2==t?(e.css("background","transparent"),!0):void 0}function traversable(e){if(37==e.keyCode){if(0==$(this).getCursorPosition()){var t;return t=$(this).parent().is("span.custom-combobox")||void 0!==$(this).attr("data-position")?$(this).parent().prev().find("input").addBack("input"):$(this).prev(),t.focus().caretTo(t.val().length),!1}}else if(38==e.keyCode){var a=$(this).parent();if("footer-japanese-sentence"!=$(this).attr("id")&&"footer-japanese"==a.attr("id")){var o=$(this).index()-2,n=$(this).getCursorPosition();$("#footer-reading input").each(function(e){var t=$(this).attr("data-position").split("-"),e=t[0];return o!=parseInt(e)||n<parseInt(t[1])||n>parseInt(t[2])?void 0:($(this).focus(),!1)})}else"footer-chinese"==a.attr("id")?a.prev().children(":nth-child("+($(this).index()+1)+")").focus():"footer-grammar"==a.attr("id")&&a.prev().children("input")[0].focus()}else if(39==e.keyCode){if($(this).getCursorPosition()==$(this).val().length){var r;return r=$(this).parent().is("span.custom-combobox")||void 0!==$(this).attr("data-position")?$(this).parent().next().find("input"):"footer-chinese-sentence"==$(this).attr("id")?$(this).next().find("input"):$(this).next(),r.focus().caretTo(0),!1}}else if(40==e.keyCode){var a=$(this).parent();if(void 0!==$(this).attr("data-position")){var i=$(this).attr("data-position").split("-"),s=parseInt(i[0]),l=parseInt(i[1]);
return $("#footer-japanese").children(":nth-child("+(s+3)+")").focus().caretTo(l),!1}if("footer-japanese"==a.attr("id"))return a.next().children(":nth-child("+($(this).index()+1)+")").find("input").addBack("input").focus(),!1;if("footer-chinese"==a.attr("id")){var c=a.next().find("input");null!=c[0]&&c[0].focus()}}}function getSubtitleRow(e){return $("#subtitle-body").children(":nth-child("+e+")")}function toSrtTime(e){var t=(""+e).split("."),a=parseInt(t[0]),o="",n=""+a%60;1==n.length?o=":0"+n:2==n.length&&(o=":"+n),a=Math.floor(a/60),n=""+a%60,1==n.length?o=":0"+n+o:2==n.length&&(o=":"+n+o),a=Math.floor(a/60),n=""+a%60,1==n.length?o="0"+n+o:2==n.length&&(o=n+o),o+=",";var r;for(r=0;r<t[1].length&&3>r;r++)o+=t[1][r];for(;3>r;r++)o+="0";return o}function toSecond(e){var t=e.split(","),a=t[0].split(":"),o=parseFloat(t[1])/1e3,n=0;return n+=60*parseInt(a[0])*60,n+=60*parseInt(a[1]),n+=parseInt(a[2]),n+=o}function loop(e,t){clearTimeout(control.loopHandler),waveform.timelineOffset=waveform.selectionStartOffset,waveform.timelineNode.css("left",waveform.timelineOffset),youtube.player.seekTo(e,!0),waveform.isClickNewTimelineOffset=!1,control.loopHandler=setInterval(function(){waveform.timelineOffset=waveform.selectionStartOffset,waveform.timelineNode.css("left",waveform.timelineOffset),youtube.player.seekTo(e,!0)},Math.floor(1e3*(parseFloat(t)-parseFloat(e))))}function verticalScaleHandler(e,t){verticalScale(-10*e+610,Math.floor(100*$("#graph").scrollLeft()/waveform.horizontalScaleFactor),100*Math.floor($("#graph").scrollLeft()+waveform.globalGraph.width())/waveform.horizontalScaleFactor),t.css({top:e+8,height:64-e}),waveform.verticalScaleFactor=-10*e+610,control.isChangeVerticalScaleFactor=!0}function visibleVerticalHandler(e){if(control.verticalIsMouseDown||"click"==e.type){var t=e.pageY-$("#video").offset().top-$("#vertical-adjust").position().top-8;t>56?t=56:0>t&&(t=0),verticalScaleHandler(t,$(this).find("div.scale-bar"))}}function adjustTimestamp(e){for(var t=$("#timestamp>span"),a=0,o=1/waveform.timeElapsedPerPixel,n=1*e/100,r=0;r<t.length;r++)$(t[r]).css({left:a}),a+=o*n}function selectedAreaHorizontalScale(e){for(var t=1;t<=edit.numberOfRow;t++){var a=Math.floor(toSecond($("#subtitle-body").children(":nth-child("+t+")").children(":nth-child(2)").text())/waveform.timeElapsedPerPixel),o=Math.floor(toSecond($("#subtitle-body").children(":nth-child("+t+")").children(":nth-child(3)").text())/waveform.timeElapsedPerPixel),n=e/100;$("#selected-area-"+t).width((o-a)*n).css("left",a*n),$("#selected-area-start-"+t).css("left",a*n-3),$("#selected-area-end-"+t).css("left",o*n)}}function visibleHorizontalHandler(e){if(control.horizontalIsMouseDown||"click"==e.type){var t=e.pageY-$("#video").offset().top-$("#horizontal-adjust").position().top-8;t>56?t=56:0>t&&(t=0);var a=-10*t+610;if(youtube.isPlaying)horizontalScale(a,0,waveform.globalSvg.childNodes.length);else if(a<waveform.horizontalScaleFactor)horizontalScale(a,Math.floor(100*$("#graph").scrollLeft()/waveform.horizontalScaleFactor),100*Math.floor($("#graph").scrollLeft()+$("#graph").width())/a);else{var o=a<waveform.horizontalScaleFactor?a:waveform.horizontalScaleFactor;horizontalScale(a,Math.floor(100*$("#graph").scrollLeft()/waveform.horizontalScaleFactor),100*Math.floor($("#graph").scrollLeft()+waveform.globalGraph.width())/o)}$("#svg").width(waveform.svgOriginalWidth*a/100),adjustTimestamp(a),selectedAreaHorizontalScale(a),hideSelectArea(),edit.currentEditIndex<1||edit.currentEditIndex>edit.numberOfRow||moveToSelectedArea($("#selected-area-"+edit.currentEditIndex)),$(this).find("div.scale-bar").css({top:t+8,height:64-t}),waveform.horizontalScaleFactor=a,reorganizeWaveform(),$("#timeline-offset").width(a/100),control.isChangeHorizontalScaleFactor=!0}}function add(){if(isSelecting()&&!isRepeatAddSelectedArea()){recordRow(edit.currentEditIndex),getSubtitleRow(edit.currentEditIndex).removeClass("focus-row"),$("#selected-area-"+edit.currentEditIndex).removeClass("focus"),editPanelReset();var e=recordSelectArea();moveToSelectedArea($("#selected-area-"+(e+1)));var t=getSubtitleRow(e);t=0==e?getSubtitleRow(1).clone(!0,!0).show().prependTo($("#subtitle-body")):getSubtitleRow(1).clone(!0,!0).show().insertAfter(getSubtitleRow(e)),scrollToRow(t),hideSelectArea(),edit.currentEditIndex=e+1,fillInSubtitleRow($("#selected-area-"+edit.currentEditIndex),t,!0,e+1,toSrtTime(pixelToSecond(waveform.selectionStartOffset)),toSrtTime(pixelToSecond(waveform.selectionEndOffset)),""),edit.changed[edit.currentEditIndex]=!0,recordRow(edit.currentEditIndex),edit.numberOfRow++;for(var a=edit.currentEditIndex+1;a<=edit.numberOfRow;a++)update(a,!0);waveform.isSetAnchor=!1,$("#anchor-annotation").hide(),$("#anchor-mask").hide(),$("#loop-mask").hide(),control.isLoop=!1}}function deleteConfirm(){isEditing()&&confirm("你確定要刪除第"+edit.currentEditIndex+"筆歌詞？")&&(deleteRow(),editPanelReset(),$("#loop-mask").hide(),control.isLoop=!1)}function deleteRow(){$("#selected-area-"+edit.currentEditIndex).remove(),$("#selected-area-start-"+edit.currentEditIndex).remove(),$("#selected-area-end-"+edit.currentEditIndex).remove();for(var e=edit.currentEditIndex+1;e<=edit.numberOfRow;e++)getSubtitleRow(e).children("div.index").text(""+(e-1)),$("#selected-area-"+e).attr("id","selected-area-"+(e-1)),$("#selected-area-start-"+e).attr("id","selected-area-start-"+(e-1)),$("#selected-area-end-"+e).attr("id","selected-area-end-"+(e-1));getSubtitleRow(edit.currentEditIndex).remove();for(var t=edit.currentEditIndex;t<edit.numberOfRow;t++)update(t,!0);$.ajax({type:"POST",url:"delete/"+youtube.videoId+"/"+edit.numberOfRow,dataType:"json",success:function(){}}),edit.currentEditIndex=0,edit.numberOfRow=edit.numberOfRow-1,waveform.focusSelectAreaIndex=0,waveform.isFocusSelectedArea=!1,waveform.selectionStartOffset=waveform.timelineOffset,waveform.selectionEndOffset=waveform.timelineOffset}function prevRow(){edit.currentEditIndex-1<1||changeRowFocus(getSubtitleRow(edit.currentEditIndex-1))}function nextRow(){edit.currentEditIndex+1>edit.numberOfRow||changeRowFocus(getSubtitleRow(edit.currentEditIndex+1))}function isEditing(){return edit.currentEditIndex>=1&&edit.currentEditIndex<=edit.numberOfRow}function init(){var e=$("#container").width();$("#graph").width(e/3*2-50),$("#subtitle-body div.subtitle-text").width(e-280),$("div.subtitle-head div.subtitle-text").width(e-280),$("#footer-header>div.subtitle-text").add("#edit-footer input.subtitle-sentence").width(280);var t=window.innerHeight||document.clientHeight||document.getElementById("body").clientHeight;$("#edit").height(t-44-330-140)}!function(e){e.widget("custom.combobox",{_create:function(){this._createAutocomplete(this.element,this.options.source),this._createShowAllButton(this.element)},_createAutocomplete:function(t,a){this.input=e("<input>").val(a[0]?a[0]:"").addClass("subtitle-vocabulary").css({border:"0px","border-right":"1px solid rgba(124,85,10,0.3)"}).bind("input",hasChanged).keydown(traversable).focus(function(){var t=e(this),a=e(this).parent().index(),o=e("#footer-japanese").children(":eq("+a+")").val();checkDictionarySource(t,o,!1)}).focusout(function(){o.autocomplete("close")}),this.input.data("source",a);var o=this.input;this.input.autocomplete({delay:0,minLength:0,source:function(e,t){t(o.data("source"))},position:{collision:"fit flip"},select:function(){hasChanged()},search:function(e){return 39==e.keyCode||37==e.keyCode?!1:void 0}}).appendTo(t)},_createShowAllButton:function(t){e("<a>").attr("tabIndex",-1).appendTo(t).addClass("combo-toggle").append(e("<span class='combo-icon'></span>")).click(function(){var t=e(this).prev(),a=e(this).parent().index(),o=e("#footer-japanese").children(":eq("+a+")").val();checkDictionarySource(t,o,!0)})}})}(jQuery),function(e){e.fn.getCursorPosition=function(){var t=e(this).get(0),a=0;if("selectionStart"in t)a=t.selectionStart;else if("selection"in document){t.focus();var o=document.selection.createRange(),n=document.selection.createRange().text.length;o.moveStart("character",-t.value.length),a=o.text.length-n}return a},e.caretTo=function(e,t){if(e.createTextRange){var a=e.createTextRange();a.move("character",t),a.select()}else null!=e.selectionStart&&(e.focus(),e.setSelectionRange(t,t))},e.fn.caretTo=function(t,a){return this.queue(function(o){if(isNaN(t)){var n=e(this).val().indexOf(t);a===!0?n+=t.length:a&&(n+=a),e.caretTo(this,n)}else e.caretTo(this,t);o()})}}(jQuery);var wanakana,__indexOf=[].indexOf||function(e){for(var t=0,a=this.length;a>t;t++)if(t in this&&this[t]===e)return t;return-1};wanakana=wanakana||{},wanakana.version="1.3.6","function"==typeof define&&define.amd&&define("wanakana",[],function(){return wanakana}),wanakana.LOWERCASE_START=97,wanakana.LOWERCASE_END=122,wanakana.UPPERCASE_START=65,wanakana.UPPERCASE_END=90,wanakana.HIRAGANA_START=12353,wanakana.HIRAGANA_END=12438,wanakana.KATAKANA_START=12449,wanakana.KATAKANA_END=12538,wanakana.LOWERCASE_FULLWIDTH_START=65345,wanakana.LOWERCASE_FULLWIDTH_END=65370,wanakana.UPPERCASE_FULLWIDTH_START=65313,wanakana.UPPERCASE_FULLWIDTH_END=65338,wanakana.defaultOptions={useObseleteKana:!1,IMEMode:!1},wanakana.bind=function(e){return e.addEventListener("input",wanakana._onInput)},wanakana.unbind=function(e){return e.removeEventListener("input",wanakana._onInput)},wanakana._onInput=function(e){var t,a,o,n,r,i;if(t=e.target,r=t.selectionStart,i=t.value.length,o=wanakana._convertFullwidthCharsToASCII(t.value),a=wanakana.toKana(o,{IMEMode:!0}),o!==a){if(t.value=a,"number"==typeof t.selectionStart)return t.selectionStart=t.selectionEnd=t.value.length;if(void 0!==t.createTextRange)return t.focus(),n=t.createTextRange(),n.collapse(!1),n.select()}},wanakana._extend=function(e,t){var a;if(null==e)return t;for(a in t)null==e[a]&&null!=t[a]&&(e[a]=t[a]);return e},wanakana._allTrue=function(e,t){var a,o,n;for(o=0,n=e.length;n>o;o++)if(a=e[o],t(a)===!1)return!1;return!0},wanakana._isCharInRange=function(e,t,a){var o;return o=e.charCodeAt(0),o>=t&&a>=o},wanakana._isCharVowel=function(e,t){var a;return null==t&&(t=!0),a=t?/[aeiouy]/:/[aeiou]/,-1!==e.toLowerCase().charAt(0).search(a)},wanakana._isCharConsonant=function(e,t){var a;return null==t&&(t=!0),a=t?/[bcdfghjklmnpqrstvwxyz]/:/[bcdfghjklmnpqrstvwxz]/,-1!==e.toLowerCase().charAt(0).search(a)},wanakana._isCharKatakana=function(e){return wanakana._isCharInRange(e,wanakana.KATAKANA_START,wanakana.KATAKANA_END)||"ー"==e},wanakana._isCharHiragana=function(e){return wanakana._isCharInRange(e,wanakana.HIRAGANA_START,wanakana.HIRAGANA_END)},wanakana._isCharKana=function(e){return wanakana._isCharHiragana(e)||wanakana._isCharKatakana(e)},wanakana._isCharNotKana=function(e){return!wanakana._isCharHiragana(e)&&!wanakana._isCharKatakana(e)},wanakana._convertFullwidthCharsToASCII=function(e){var t,a,o,n,r,i;for(a=e.split(""),n=r=0,i=a.length;i>r;n=++r)t=a[n],o=t.charCodeAt(0),wanakana._isCharInRange(t,wanakana.LOWERCASE_FULLWIDTH_START,wanakana.LOWERCASE_FULLWIDTH_END)&&(a[n]=String.fromCharCode(o-wanakana.LOWERCASE_FULLWIDTH_START+wanakana.LOWERCASE_START)),wanakana._isCharInRange(t,wanakana.UPPERCASE_FULLWIDTH_START,wanakana.UPPERCASE_FULLWIDTH_END)&&a[n](String.fromCharCode(o-wanakana.UPPERCASE_FULLWIDTH_START+wanakana.UPPERCASE_START));return a.join("")},wanakana._katakanaToHiragana=function(e){var t,a,o,n,r,i,s;for(a=[],s=e.split(""),r=0,i=s.length;i>r;r++)n=s[r],wanakana._isCharKatakana(n)?(t=n.charCodeAt(0),t+=wanakana.HIRAGANA_START-wanakana.KATAKANA_START,o=String.fromCharCode(t),a.push(o)):a.push(n);return a.join("")},wanakana._hiraganaToKatakana=function(e){var t,a,o,n,r,i,s;for(o=[],s=e.split(""),r=0,i=s.length;i>r;r++)a=s[r],wanakana._isCharHiragana(a)?(t=a.charCodeAt(0),t+=wanakana.KATAKANA_START-wanakana.HIRAGANA_START,n=String.fromCharCode(t),o.push(n)):o.push(a);return o.join("")},wanakana._hiraganaToRomaji=function(e,t){var a,o,n,r,i,s,l,c,f,d;for(t=wanakana._extend(t,wanakana.defaultOptions),i=e.length,f=[],n=0,o=0,s=2,r=function(){return e.substr(n,o)},c=function(){return o=Math.min(s,i-n)};i>n;){for(c();o>0;){if(a=r(),wanakana.isKatakana(a)&&(a=wanakana._katakanaToHiragana(a)),"っ"===a.charAt(0)&&1===o&&i-1>n){l=!0,d="";break}if(d=wanakana.J_to_R[a],null!=d&&l&&(d=d.charAt(0).concat(d),l=!1),null!=d)break;o--}null==d&&(d=a),f.push(d),n+=o||1}return f.join("")},wanakana._romajiToHiragana=function(e,t){return wanakana._romajiToKana(e,t,!0)},wanakana._romajiToKana=function(e,t,a){var o,n,r,i,s,l,c,f,d,u;for(null==a&&(a=!1),t=wanakana._extend(t,wanakana.defaultOptions),d=e.length,c=[],i=0,u=3,s=function(){return e.substr(i,r)},l=function(e){return wanakana._isCharInRange(e,wanakana.UPPERCASE_START,wanakana.UPPERCASE_END)};d>i;){for(r=Math.min(u,d-i);r>0;){if(o=s(),n=o.toLowerCase(),__indexOf.call(wanakana.FOUR_CHARACTER_EDGE_CASES,n)<0||4>d-i){if("n"===n.charAt(0)){if(t.IMEMode&&"'"===n.charAt(1)&&2===r){f="ん";break}wanakana._isCharConsonant(n.charAt(1),!1)&&wanakana._isCharVowel(n.charAt(2))&&(r=1,o=s(),n=o.toLowerCase())}"n"!==n.charAt(0)&&wanakana._isCharConsonant(n.charAt(0))&&o.charAt(0)===o.charAt(1)&&(r=1,n=o=wanakana._isCharInRange(o.charAt(0),wanakana.UPPERCASE_START,wanakana.UPPERCASE_END)?"ッ":"っ")}else r++,o=s(),n=o.toLowerCase();if(f=wanakana.R_to_J[n],null!=f)break;4===r?r-=2:r--}null==f&&(o=wanakana._convertPunctuation(o),f=o),(null!=t?t.useObseleteKana:void 0)&&("wi"===n&&(f="ゐ"),"we"===n&&(f="ゑ")),t.IMEMode&&"n"===n.charAt(0)&&("y"===e.charAt(i+1).toLowerCase()&&wanakana._isCharVowel(e.charAt(i+2))===!1||i===d-1||wanakana.isKana(e.charAt(i+1)))&&(f=o.charAt(0)),a||l(o.charAt(0))&&(f=wanakana._hiraganaToKatakana(f)),c.push(f),i+=r||1}return c.join("")},wanakana._convertPunctuation=function(e){return"　"===e?" ":"-"===e?"ー":e},wanakana.isHiragana=function(e){var t;return t=e.split(""),wanakana._allTrue(t,wanakana._isCharHiragana)},wanakana.isKatakana=function(e){var t;return t=e.split(""),wanakana._allTrue(t,wanakana._isCharKatakana)},wanakana.isKana=function(e){var t;return t=e.split(""),wanakana._allTrue(t,function(e){return wanakana.isHiragana(e)||wanakana.isKatakana(e)})},wanakana.isRomaji=function(e){var t;return t=e.split(""),wanakana._allTrue(t,function(e){return!wanakana.isHiragana(e)&&!wanakana.isKatakana(e)})},wanakana.toHiragana=function(e,t){return wanakana.isRomaji(e)?e=wanakana._romajiToHiragana(e,t):wanakana.isKatakana(e)?e=wanakana._katakanaToHiragana(e,t):e},wanakana.toKatakana=function(e,t){return wanakana.isHiragana(e)?e=wanakana._hiraganaToKatakana(e,t):wanakana.isRomaji(e)?(e=wanakana._romajiToHiragana(e,t),e=wanakana._hiraganaToKatakana(e,t)):e},wanakana.toKana=function(e,t){return e=wanakana._romajiToKana(e,t)},wanakana.toRomaji=function(e){return e=wanakana._hiraganaToRomaji(e)},wanakana.R_to_J={a:"あ",i:"い",u:"う",e:"え",o:"お",yi:"い",wu:"う",whu:"う",xa:"ぁ",xi:"ぃ",xu:"ぅ",xe:"ぇ",xo:"ぉ",xyi:"ぃ",xye:"ぇ",ye:"いぇ",wha:"うぁ",whi:"うぃ",whe:"うぇ",who:"うぉ",wi:"うぃ",we:"うぇ",va:"ゔぁ",vi:"ゔぃ",vu:"ゔ",ve:"ゔぇ",vo:"ゔぉ",vya:"ゔゃ",vyi:"ゔぃ",vyu:"ゔゅ",vye:"ゔぇ",vyo:"ゔょ",ka:"か",ki:"き",ku:"く",ke:"け",ko:"こ",lka:"ヵ",lke:"ヶ",xka:"ヵ",xke:"ヶ",kya:"きゃ",kyi:"きぃ",kyu:"きゅ",kye:"きぇ",kyo:"きょ",ca:"か",ci:"き",cu:"く",ce:"け",co:"こ",lca:"ヵ",lce:"ヶ",xca:"ヵ",xce:"ヶ",qya:"くゃ",qyu:"くゅ",qyo:"くょ",qwa:"くぁ",qwi:"くぃ",qwu:"くぅ",qwe:"くぇ",qwo:"くぉ",qa:"くぁ",qi:"くぃ",qe:"くぇ",qo:"くぉ",kwa:"くぁ",qyi:"くぃ",qye:"くぇ",ga:"が",gi:"ぎ",gu:"ぐ",ge:"げ",go:"ご",gya:"ぎゃ",gyi:"ぎぃ",gyu:"ぎゅ",gye:"ぎぇ",gyo:"ぎょ",gwa:"ぐぁ",gwi:"ぐぃ",gwu:"ぐぅ",gwe:"ぐぇ",gwo:"ぐぉ",sa:"さ",si:"し",shi:"し",su:"す",se:"せ",so:"そ",za:"ざ",zi:"じ",zu:"ず",ze:"ぜ",zo:"ぞ",ji:"じ",sya:"しゃ",syi:"しぃ",syu:"しゅ",sye:"しぇ",syo:"しょ",sha:"しゃ",shu:"しゅ",she:"しぇ",sho:"しょ",shya:"しゃ",shyu:"しゅ",shye:"しぇ",shyo:"しょ",swa:"すぁ",swi:"すぃ",swu:"すぅ",swe:"すぇ",swo:"すぉ",zya:"じゃ",zyi:"じぃ",zyu:"じゅ",zye:"じぇ",zyo:"じょ",ja:"じゃ",ju:"じゅ",je:"じぇ",jo:"じょ",jya:"じゃ",jyi:"じぃ",jyu:"じゅ",jye:"じぇ",jyo:"じょ",ta:"た",ti:"ち",tu:"つ",te:"て",to:"と",chi:"ち",tsu:"つ",ltu:"っ",xtu:"っ",tya:"ちゃ",tyi:"ちぃ",tyu:"ちゅ",tye:"ちぇ",tyo:"ちょ",cha:"ちゃ",chu:"ちゅ",che:"ちぇ",cho:"ちょ",cya:"ちゃ",cyi:"ちぃ",cyu:"ちゅ",cye:"ちぇ",cyo:"ちょ",chya:"ちゃ",chyu:"ちゅ",chye:"ちぇ",chyo:"ちょ",tsa:"つぁ",tsi:"つぃ",tse:"つぇ",tso:"つぉ",tha:"てゃ",thi:"てぃ",thu:"てゅ",the:"てぇ",tho:"てょ",twa:"とぁ",twi:"とぃ",twu:"とぅ",twe:"とぇ",two:"とぉ",da:"だ",di:"ぢ",du:"づ",de:"で","do":"ど",dya:"ぢゃ",dyi:"ぢぃ",dyu:"ぢゅ",dye:"ぢぇ",dyo:"ぢょ",dha:"でゃ",dhi:"でぃ",dhu:"でゅ",dhe:"でぇ",dho:"でょ",dwa:"どぁ",dwi:"どぃ",dwu:"どぅ",dwe:"どぇ",dwo:"どぉ",na:"な",ni:"に",nu:"ぬ",ne:"ね",no:"の",nya:"にゃ",nyi:"にぃ",nyu:"にゅ",nye:"にぇ",nyo:"にょ",ha:"は",hi:"ひ",hu:"ふ",he:"へ",ho:"ほ",fu:"ふ",hya:"ひゃ",hyi:"ひぃ",hyu:"ひゅ",hye:"ひぇ",hyo:"ひょ",fya:"ふゃ",fyu:"ふゅ",fyo:"ふょ",fwa:"ふぁ",fwi:"ふぃ",fwu:"ふぅ",fwe:"ふぇ",fwo:"ふぉ",fa:"ふぁ",fi:"ふぃ",fe:"ふぇ",fo:"ふぉ",fyi:"ふぃ",fye:"ふぇ",ba:"ば",bi:"び",bu:"ぶ",be:"べ",bo:"ぼ",bya:"びゃ",byi:"びぃ",byu:"びゅ",bye:"びぇ",byo:"びょ",pa:"ぱ",pi:"ぴ",pu:"ぷ",pe:"ぺ",po:"ぽ",pya:"ぴゃ",pyi:"ぴぃ",pyu:"ぴゅ",pye:"ぴぇ",pyo:"ぴょ",ma:"ま",mi:"み",mu:"む",me:"め",mo:"も",mya:"みゃ",myi:"みぃ",myu:"みゅ",mye:"みぇ",myo:"みょ",ya:"や",yu:"ゆ",yo:"よ",xya:"ゃ",xyu:"ゅ",xyo:"ょ",ra:"ら",ri:"り",ru:"る",re:"れ",ro:"ろ",rya:"りゃ",ryi:"りぃ",ryu:"りゅ",rye:"りぇ",ryo:"りょ",la:"ら",li:"り",lu:"る",le:"れ",lo:"ろ",lya:"りゃ",lyi:"りぃ",lyu:"りゅ",lye:"りぇ",lyo:"りょ",wa:"わ",wo:"を",lwe:"ゎ",xwa:"ゎ",n:"ん",nn:"ん","n ":"ん",xn:"ん",ltsu:"っ"},wanakana.FOUR_CHARACTER_EDGE_CASES=["lts","chy","shy"],wanakana.J_to_R={"あ":"a","い":"i","う":"u","え":"e","お":"o","ゔぁ":"va","ゔぃ":"vi","ゔ":"vu","ゔぇ":"ve","ゔぉ":"vo","か":"ka","き":"ki","きゃ":"kya","きぃ":"kyi","きゅ":"kyu","く":"ku","け":"ke","こ":"ko","が":"ga","ぎ":"gi","ぐ":"gu","げ":"ge","ご":"go","ぎゃ":"gya","ぎぃ":"gyi","ぎゅ":"gyu","ぎぇ":"gye","ぎょ":"gyo","さ":"sa","す":"su","せ":"se","そ":"so","ざ":"za","ず":"zu","ぜ":"ze","ぞ":"zo","し":"shi","しゃ":"sha","しゅ":"shu","しょ":"sho","じ":"ji","じゃ":"ja","じゅ":"ju","じょ":"jo","た":"ta","ち":"chi","ちゃ":"cha","ちゅ":"chu","ちょ":"cho","つ":"tsu","て":"te","と":"to","だ":"da","ぢ":"di","づ":"du","で":"de","ど":"do","な":"na","に":"ni","にゃ":"nya","にゅ":"nyu","にょ":"nyo","ぬ":"nu","ね":"ne","の":"no","は":"ha","ひ":"hi","ふ":"fu","へ":"he","ほ":"ho","ひゃ":"hya","ひゅ":"hyu","ひょ":"hyo","ふぁ":"fa","ふぃ":"fi","ふぇ":"fe","ふぉ":"fo","ば":"ba","び":"bi","ぶ":"bu","べ":"be","ぼ":"bo","びゃ":"bya","びゅ":"byu","びょ":"byo","ぱ":"pa","ぴ":"pi","ぷ":"pu","ぺ":"pe","ぽ":"po","ぴゃ":"pya","ぴゅ":"pyu","ぴょ":"pyo","ま":"ma","み":"mi","む":"mu","め":"me","も":"mo","みゃ":"mya","みゅ":"myu","みょ":"myo","や":"ya","ゆ":"yu","よ":"yo","ら":"ra","り":"ri","る":"ru","れ":"re","ろ":"ro","りゃ":"rya","りゅ":"ryu","りょ":"ryo","わ":"wa","を":"wo","ん":"n","ゐ":"wi","ゑ":"we","きぇ":"kye","きょ":"kyo","じぃ":"jyi","じぇ":"jye","ちぃ":"cyi","ちぇ":"che","ひぃ":"hyi","ひぇ":"hye","びぃ":"byi","びぇ":"bye","ぴぃ":"pyi","ぴぇ":"pye","みぇ":"mye","みぃ":"myi","りぃ":"ryi","りぇ":"rye","にぃ":"nyi","にぇ":"nye","しぃ":"syi","しぇ":"she","いぇ":"ye","うぁ":"wha","うぉ":"who","うぃ":"wi","うぇ":"we","ゔゃ":"vya","ゔゅ":"vyu","ゔょ":"vyo","すぁ":"swa","すぃ":"swi","すぅ":"swu","すぇ":"swe","すぉ":"swo","くゃ":"qya","くゅ":"qyu","くょ":"qyo","くぁ":"qwa","くぃ":"qwi","くぅ":"qwu","くぇ":"qwe","くぉ":"qwo","ぐぁ":"gwa","ぐぃ":"gwi","ぐぅ":"gwu","ぐぇ":"gwe","ぐぉ":"gwo","つぁ":"tsa","つぃ":"tsi","つぇ":"tse","つぉ":"tso","てゃ":"tha","てぃ":"thi","てゅ":"thu","てぇ":"the","てょ":"tho","とぁ":"twa","とぃ":"twi","とぅ":"twu","とぇ":"twe","とぉ":"two","ぢゃ":"dya","ぢぃ":"dyi","ぢゅ":"dyu","ぢぇ":"dye","ぢょ":"dyo","でゃ":"dha","でぃ":"dhi","でゅ":"dhu","でぇ":"dhe","でょ":"dho","どぁ":"dwa","どぃ":"dwi","どぅ":"dwu","どぇ":"dwe","どぉ":"dwo","ふぅ":"fwu","ふゃ":"fya","ふゅ":"fyu","ふょ":"fyo","ぁ":"a","ぃ":"i","ぇ":"e","ぅ":"u","ぉ":"o","ゃ":"ya","ゅ":"yu","ょ":"yo","っ":"","ゕ":"ka","ゖ":"ka","ゎ":"wa","　":" ","んあ":"n'a","んい":"n'i","んう":"n'u","んえ":"n'e","んお":"n'o","んや":"n'ya","んゆ":"n'yu","んよ":"n'yo"},function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){function t(t){var n=t||window.event,r=[].slice.call(arguments,1),i=0,s=0,l=0,c=0,f=0;return t=e.event.fix(n),t.type="mousewheel",n.wheelDelta&&(i=n.wheelDelta),n.detail&&(i=-1*n.detail),n.deltaY&&(l=-1*n.deltaY,i=l),n.deltaX&&(s=n.deltaX,i=-1*s),void 0!==n.wheelDeltaY&&(l=n.wheelDeltaY),void 0!==n.wheelDeltaX&&(s=-1*n.wheelDeltaX),c=Math.abs(i),(!a||a>c)&&(a=c),f=Math.max(Math.abs(l),Math.abs(s)),(!o||o>f)&&(o=f),r.unshift(t,Math.floor(i/a),Math.floor(s/o),Math.floor(l/o)),(e.event.dispatch||e.event.handle).apply(this,r)}var a,o,n=["wheel","mousewheel","DOMMouseScroll"],r="onwheel"in document||document.documentMode>=9?["wheel"]:["mousewheel","DomMouseScroll","MozMousePixelScroll"];if(e.event.fixHooks)for(var i=n.length;i;)e.event.fixHooks[n[--i]]=e.event.mouseHooks;e.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=r.length;e;)this.addEventListener(r[--e],t,!1);else this.onmousewheel=t},teardown:function(){if(this.removeEventListener)for(var e=r.length;e;)this.removeEventListener(r[--e],t,!1);else this.onmousewheel=null}},e.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}),$(document).ready(function(){$.fn.tooltip.noConflict(),init(),$("#comment").popover({html:!0,template:'<div class="popover" role="tooltip"><div class="arrow"></div><div class="popover-content"></div></div>',content:function(){return'<div class="grammar"><div class="panel panel-default"><div class="panel-heading">附註<button type="button" class="close close-popover"><span aria-hidden="true">×</span></button></div><textarea rows="4" >'+$(this).attr("data-popover")+"</textarea></div></div>"},placement:function(){return"bottom"},trigger:"manual"}).click(function(e){$(this).popover("toggle"),e.stopPropagation()}).attr("title","附註"),$("#comment").on("hide.bs.popover",function(){var e=$(this).next().find("textarea").val();e!=$(this).attr("data-popover")&&($(this).attr("data-popover",e),$.ajax({type:"POST",url:"/edit/update/comment/"+youtube.videoId,data:{comment:e}},"json"))}),$("#control>div.button").tooltip(tooltipInit),window.onbeforeunload=function(){isChanged(edit.currentEditIndex)&&recordRow(edit.currentEditIndex)},$("#footer-body").add("#graph").mousewheel(function(e,t){this.scrollLeft-=20*t}),$("#keyin").keydown(function(e){13==e.keyCode&&searchInYoutube($(this).val())}),$("input.submit").click(function(){searchInYoutube($("#keyin").val())}),$("#anchor").click(setAnchor),$("#publish").click(function(){recordRow(edit.currentEditIndex,!1),$("#publish-mask").is(":visible")?($(this).tooltip("option","content","發佈"),$("#publish-mask").hide(),$.ajax({type:"POST",url:"/edit/unpublish/"+youtube.videoId},"json")):($(this).tooltip("option","content","取消發佈"),$("#publish-mask").show(),$.ajax({type:"POST",url:"/edit/publish/"+youtube.videoId},"json"))}),$("body").on("click",function(){void 0!==$("#comment").attr("aria-describedby")&&$("#comment").popover("toggle")}),$("#control").on("click",".close-popover",function(){void 0!==$("#comment").attr("aria-describedby")&&$("#comment").popover("toggle")}).on("click","div.popover",function(e){e.stopPropagation()}),$("#delete").click(deleteConfirm),$("div.subtitle-row").click(function(){changeRowFocus($(this)),$("#footer-japanese-sentence").focus()}),$("#footer-japanese-sentence").keyup(function(e){if(!(!isChangeText(e)||!isEditing()||(e.ctrlKey||e.metaKey)&&67==e.keyCode||(e.ctrlKey||e.metaKey)&&65==e.keyCode||(e.ctrlKey||e.metaKey)&&e.shiftKey||(e.ctrlKey||e.metaKey)&&e.altKey)){edit.isShowVocab||($(this).after(getJapaneseVocab()),$("#footer-chinese-sentence").after(getChineseVocab()),edit.isShowVocab=!0);var t=$(this).val();getSubtitleRow(edit.currentEditIndex).children(":nth-child(4)").text(t),adjustVocabularyWidth($(this).index()+1+1),$(this).nextAll().each(function(){validateFooterInput($(this))})}}).focusout(determineGrammar).on("input",function(){validateFooterInput($(this)),hasChanged(),edit.isJapaneseSentenceChanged=!0}),$("#footer-chinese-sentence").on("input",function(){validateFooterInput($(this)),hasChanged()}),$("#add").click(add),$("#loop").click(function(){$("#loop-mask").is(":visible")?(control.isLoop=!1,$("#loop-mask").hide(),$("#loop").tooltip("option","content","循環播放")):isSelecting()&&(waveform.timelineOffset=waveform.selectionStartOffset,waveform.timelineNode.css("left",waveform.timelineOffset),control.isLoop=!0,youtube.player.playVideo(),$("#loop-mask").show(),$(this).tooltip("option","content","停止循環播放"))}),$("#body").mousemove(function(e){return waveform.isSelectionMouseDown||waveform.isAdjustStartSelectLine||waveform.isAdjustEndSelectLine||waveform.isSelectAreaStartMouseDown||waveform.isSelectAreaEndMouseDown?(e.preventDefault(),void e.stopPropagation()):void 0}),$("#graph").mousedown(function(e){if(isInSvg(e)){var t=getMouseOnGraphOffset(e);if(!waveform.isSetAnchor||waveform.isSelectAreaStartMouseDown||waveform.isSelectAreaEndMouseDown)waveform.isSelectAreaStartMouseDown||waveform.isSelectAreaEndMouseDown||waveform.isAdjustStartSelectLine||waveform.isAdjustEndSelectLine||waveform.isFocusSelectedArea?waveform.isSelectAreaStartMouseDown||waveform.isSelectAreaEndMouseDown?(waveform.isSelectAreaStartMouseDown?waveform.pseudoNodeIndex=getPseudoNodeIndex(t+3):waveform.isSelectAreaEndMouseDown&&(waveform.pseudoNodeIndex=getPseudoNodeIndex(t-3)),waveform.timelineOffset=t,waveform.timelineNode.css("left",waveform.timelineOffset),waveform.isClickNewTimelineOffset=!0):(waveform.isAdjustStartSelectLine||waveform.isAdjustEndSelectLine)&&(hideSelectArea(),waveform.timelineOffset=t,waveform.timelineNode.css("left",t),waveform.isClickNewTimelineOffset=!0):(hideSelectArea(),waveform.pseudoNodeIndex=getPseudoNodeIndex(t),waveform.selectionStartOffset=t,waveform.timelineOffset=t,waveform.timelineNode.css("left",waveform.timelineOffset),waveform.isClickNewTimelineOffset=!0,waveform.isSelectionMouseDown=!0);else{if(mouseoverSelectedArea(t))return;waveform.pseudoNodeIndex=getPseudoNodeIndex(t),waveform.timelineOffset=t,waveform.timelineNode.css("left",waveform.timelineOffset),determineSelectArea(t),waveform.selectionEndOffset=waveform.selectionStartOffset>t?$("#graph").scrollLeft()+$("#select-area").position().left-3:$("#graph").scrollLeft()+$("#select-area").position().left+$("#select-area").width(),$("#select-area-end").css({display:"inline-block",left:waveform.selectionEndOffset}),waveform.isClickNewTimelineOffset=!0}}}).mousemove(function(e){var t=getMouseOnGraphOffset(e);if(waveform.isSelectAreaStartMouseDown){if(mouseoverSelectedArea(t))return void clearScrollHandler();determineScroll(t),resizeSelectAreaFromStartOffset(t)}else if(waveform.isSelectAreaEndMouseDown){if(mouseoverSelectedArea(t))return void clearScrollHandler();determineScroll(t),resizeSelectAreaFromEndOffset(t)}else if(waveform.isAdjustStartSelectLine){if(1!=waveform.focusSelectAreaIndex&&t<$("#graph").scrollLeft()+$("#selected-area-"+(waveform.focusSelectAreaIndex-1)).position().left+$("#selected-area-"+(waveform.focusSelectAreaIndex-1)).width())return void clearScrollHandler();determineScroll(t),adjustSelectedAreaFromStartLine(t)}else if(waveform.isAdjustEndSelectLine){if(waveform.focusSelectAreaIndex!=edit.numberOfRow&&t>$("#graph").scrollLeft()+$("#selected-area-"+(waveform.focusSelectAreaIndex+1)).position().left)return void clearScrollHandler();determineScroll(t),adjustSelectedAreaFromEndLine(t)}else if(waveform.isSelectionMouseDown){if(mouseoverSelectedArea(t))return void clearScrollHandler();determineScroll(t),determineSelectArea(t),$("#select-area-start").css({display:"inline-block",left:$("#graph").scrollLeft()+$("#select-area").position().left-3}),$("#select-area-end").css({display:"inline-block",left:$("#graph").scrollLeft()+$("#select-area").position().left+$("#select-area").width()})}}).mouseup(function(e){if(isInSvg(e)){var t=getMouseOnGraphOffset(e);if(waveform.isSelectAreaStartMouseDown)clearScrollHandler(),waveform.timelineOffset=mouseoverSelectedArea(t)?t<waveform.selectionEndOffset?$("#selected-area-"+(waveform.pseudoNodeIndex-1)).position().left+$("#graph").scrollLeft()+$("#selected-area-"+(waveform.pseudoNodeIndex-1)).width():$("#selected-area-"+waveform.pseudoNodeIndex).position().left+$("#graph").scrollLeft():t,waveform.timelineNode.css("left",waveform.timelineOffset),resizeSelectAreaFromStartOffset(waveform.timelineOffset);else if(waveform.isSelectAreaEndMouseDown)clearScrollHandler(),waveform.timelineOffset=mouseoverSelectedArea(t)?waveform.selectionStartOffset<t?$("#selected-area-"+waveform.pseudoNodeIndex).position().left+$("#graph").scrollLeft():$("#selected-area-"+(waveform.pseudoNodeIndex-1)).position().left+$("#graph").scrollLeft()+$("#selected-area-"+(waveform.pseudoNodeIndex-1)).width():t,waveform.timelineNode.css("left",waveform.timelineOffset),resizeSelectAreaFromEndOffset(waveform.timelineOffset);else if(waveform.isAdjustStartSelectLine)waveform.timelineOffset=1!=waveform.focusSelectAreaIndex&&t<$("#graph").scrollLeft()+$("#selected-area-"+(waveform.focusSelectAreaIndex-1)).position().left+$("#selected-area-"+(waveform.focusSelectAreaIndex-1)).width()?$("#graph").scrollLeft()+$("#selected-area-"+waveform.focusSelectAreaIndex).position().left:t,clearScrollHandler(),waveform.timelineNode.css("left",waveform.timelineOffset),adjustSelectedAreaFromStartLine(waveform.timelineOffset),edit.changed[waveform.focusSelectAreaIndex]=!0;else if(waveform.isAdjustEndSelectLine)waveform.timelineOffset=waveform.focusSelectAreaIndex!=edit.numberOfRow&&t>$("#graph").scrollLeft()+$("#selected-area-"+(waveform.focusSelectAreaIndex+1)).position().left?$("#graph").scrollLeft()+$("#selected-area-"+waveform.focusSelectAreaIndex).position().left+$("#selected-area-"+waveform.focusSelectAreaIndex).width():t,clearScrollHandler(),waveform.timelineNode.css("left",waveform.timelineOffset),adjustSelectedAreaFromEndLine(waveform.timelineOffset),edit.changed[waveform.focusSelectAreaIndex]=!0;else if(waveform.isSelectionMouseDown){if(mouseoverSelectedArea(t)?t>waveform.selectionStartOffset?(determineSelectArea($("#selected-area-"+waveform.pseudoNodeIndex).position().left+$("#graph").scrollLeft()),waveform.timelineOffset=$("#selected-area-"+waveform.pseudoNodeIndex).position().left+$("#graph").scrollLeft()):(determineSelectArea($("#selected-area-"+(waveform.pseudoNodeIndex-1)).position().left+$("#graph").scrollLeft()+$("#selected-area-"+(waveform.pseudoNodeIndex-1)).width()),waveform.timelineOffset=$("#selected-area-"+(waveform.pseudoNodeIndex-1)).position().left+$("#graph").scrollLeft()+$("#selected-area-"+(waveform.pseudoNodeIndex-1)).width()):waveform.selectionStartOffset!=waveform.selectionEndOffset&&(determineSelectArea(t),waveform.timelineOffset=t),waveform.selectionStartOffset>waveform.selectionEndOffset){var a=waveform.selectionStartOffset;waveform.selectionStartOffset=waveform.selectionEndOffset,waveform.selectionEndOffset=a}clearScrollHandler(),waveform.timelineNode.css("left",waveform.timelineOffset),$("#select-area-start").css({display:"inline-block",left:$("#graph").scrollLeft()+$("#select-area").position().left-3}),$("#select-area-end").css({display:"inline-block",left:$("#graph").scrollLeft()+$("#select-area").position().left+$("#select-area").width()})}else waveform.isFocusSelectedArea&&$("#footer-japanese-sentence").focus();waveform.isAdjustStartSelectLine=!1,waveform.isAdjustEndSelectLine=!1,waveform.isSelectionMouseDown=!1,waveform.isSelectAreaStartMouseDown=!1,waveform.isSelectAreaEndMouseDown=!1,waveform.isFocusSelectedArea=!1}}).scroll(reorganizeWaveform).dblclick(function(){pauseVideo()}),document.getElementById("graph").onselectstart=function(){return!1},$("#vertical-scale").mouseenter(function(){$("#vertical-adjust").css("top",$(this).position().top),$("#vertical-adjust").show().animate({height:"+=80px",top:"-=80px"},100)}).mouseleave(function(){control.verticalIsMouseDown=!1,control.isChangeVerticalScaleFactor&&(control.isChangeVerticalScaleFactor=!1,verticalScale(waveform.verticalScaleFactor,0,waveform.globalSvg.childNodes.length)),$("#vertical-adjust").animate({height:"-=80px",top:"+=80px"},200,function(){$(this).hide()})}),$("#vertical-adjust").mousedown(function(){control.verticalIsMouseDown=!0}).mousemove(visibleVerticalHandler).click(visibleVerticalHandler).mouseup(function(){control.verticalIsMouseDown=!1}),document.getElementById("vertical-adjust").onselectstart=function(){return!1},$("#horizontal-scale").mouseenter(function(){$("#horizontal-adjust").css("top",$(this).position().top),$("#horizontal-adjust").show().animate({height:"+=80px",top:"-=80px"},100)
}).mouseleave(function(){control.horizontalIsMouseDown=!1,control.isChangeHorizontalScaleFactor&&(control.isChangeHorizontalScaleFactor=!1,horizontalScale(waveform.horizontalScaleFactor,0,waveform.globalSvg.childNodes.length),0==edit.currentEditIndex&&(waveform.selectionStartOffset=waveform.timelineOffset,waveform.selectionEndOffset=waveform.timelineOffset)),$("#horizontal-adjust").animate({height:"-=80px",top:"+=80px"},200,function(){$(this).hide()})}),$("#horizontal-adjust").mousedown(function(){control.horizontalIsMouseDown=!0}).mousemove(visibleHorizontalHandler).click(visibleHorizontalHandler).mouseup(function(){control.horizontalIsMouseDown=!1}),document.getElementById("horizontal-adjust").onselectstart=function(){return!1},$("#edit-footer input").keydown(traversable)});