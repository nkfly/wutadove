function getVideoIdArrayFromUrl(){if(videoIdArray=[],-1!=(""+window.location).indexOf("?"))for(var e=(""+window.location).split("?")[1].split("&"),i=0;i<e.length;i++)e[i].match(/^v=/)&&videoIdArray.push(e[i].split("=")[1]);return videoIdArray}function makeVideoRow(e,i,o,t,a,r){var d='<div id="video-row-'+i+'" class="video-row"><span class="row-image"><img style="width:120px;height:90px;" src="http://img.youtube.com/vi/'+i+'/mqdefault.jpg"><span class="video-time">'+toSimpleTime(o)+'</span></span><div class="row-middle"><div class="row-line line-title">'+t+'</div><div class="row-line line-description">'+a+'</div></div><div class="row-right"><div class="row-line line-like"></div><div class="row-line line-author"></div></div></div></div>';return $videoRow=$(d),-1!=$.inArray(i,r.inDatabase)?($videoRow.find("div.row-middle").append($('<a href="/learn/'+i+"/"+r.index[e]+'"><div class="line-action">勉強</div></a>')),$videoRow.find("div.row-right div.line-like").text(r.view[e]+" 次觀看"),$videoRow.find("div.line-author").html(r.author[e]+" 編")):($videoRow.find("div.row-middle").append($('<a href="/edit/'+i+'"><div class="line-action">編輯</div></a>')),$videoRow.find("div.row-right div.line-like").text("0  次觀看"),$videoRow.find("div.line-author").text("未編輯")),$videoRow}function appendVideoRow(e){var i=[];$(e).find("atom\\:entry, entry").each(function(e){for(var o=$(this),t=o[0],a=videoIdArray[e],r=$(t.getElementsByTagNameNS("http://gdata.youtube.com/schemas/2007","duration")[0]).attr("seconds"),d=$(t.getElementsByTagNameNS("http://search.yahoo.com/mrss/","title")[0]).text(),n=$(t.getElementsByTagNameNS("http://search.yahoo.com/mrss/","description")[0]).text(),s=!1,v=0;v<searchResponse.inDatabase.length;v++)searchResponse.inDatabase[v]==a&&(makeVideoRow(v,a,r,d,n,searchResponse).appendTo("#container"),s=!0);s||i.push(makeVideoRow(e,a,r,d,n,searchResponse))});for(var o=0;o<i.length;o++)i[o].appendTo("#container");setUpSearchPager()}function youtubeV3BatchProcessing(e){var i=$("#keyin").val(),o=gapi.client.youtube.search.list({q:i,part:"snippet",type:"video",maxResults:50,order:"relevance",videoDuration:"medium"});o.execute(function(i){if(i.items){for(var o=[],t=0,a=0;a<i.items.length;a++){var r=e.indexOf(i.items[a].id.videoId);if(-1!=r){var d=i.items[a].id.videoId,n="5",s=i.items[a].snippet.title,v=i.items[a].snippet.description;-1!=$.inArray(d,searchResponse.inDatabase)?(makeVideoRow(t,d,n,s,v,searchResponse).appendTo("#container"),t++):o.push(makeVideoRow(-1,d,n,s,v,searchResponse))}}for(var a=0;a<o.length;a++)o[a].appendTo("#container")}})}function setUpSearchPager(){var e=$("#keyin").val();if(!isYoutubeUrl(e)&&""!=e){var i=gapi.client.youtube.search.list({q:e,part:"snippet",type:"video",maxResults:50,order:"relevance",videoDuration:"medium"});i.execute(function(i){if(i.items)for(var o=5,t=0,a="/search?",r=a,d=getVideoIdArrayFromUrl(),n=0;n<i.items.length;n++)if(t++,r+="v="+i.items[n].id.videoId+"&",t%o==0){r+="q="+e;var s=$("#pager-box-prototype").clone().attr("id","");s.attr("href",r),s.find("span").text(t/o),-1!=$.inArray(i.items[n].id.videoId,d)&&s.css("background-color","#bbb"),s.show().appendTo($("#pager")),r=a}})}}function onYoutubeApiLoad(){$(document).ready(function(){videoIdArray=getVideoIdArrayFromUrl(),youtubeBatchProcessing(videoIdArray,appendVideoRow)})}